name: PR Validation

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write
  security-events: write
  packages: write

env:
  REGISTRY: ttl.sh
  IMAGE_NAME: minecraft-operator-${{ github.event.pull_request.number }}-1d

jobs:
  security:
    name: Security Scan
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
          category: trivy-filesystem

  lint:
    name: Lint
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.4.0

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: "**/*.md"

  test:
    name: Test
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Setup envtest
        run: |
          go install sigs.k8s.io/controller-runtime/tools/setup-envtest@latest
          echo "KUBEBUILDER_ASSETS=$(setup-envtest use --print path --bin-dir "${GITHUB_WORKSPACE}/bin")" >> "$GITHUB_ENV"

      - name: Run tests with coverage
        run: |
          go test -race -coverprofile=coverage.out ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  build-and-push:
    name: Build (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs:
      - security
      - lint
      - test
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-24.04
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    outputs:
      digest-amd64: ${{ steps.push.outputs.digest }}
      digest-arm64: ${{ steps.push.outputs.digest }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ttl.sh
        run: echo "ttl.sh does not require authentication"

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ matrix.arch }}

      - name: Build and push by digest
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: build/Containerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.arch }}
          build-args: |
            VERSION=pr-${{ github.event.pull_request.number }}
            REVISION=${{ github.sha }}
            BUILD_DATE=${{ github.event.pull_request.updated_at }}
          cache-from: type=gha,scope=build-${{ matrix.arch }}
          cache-to: type=gha,scope=build-${{ matrix.arch }},mode=max

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.push.outputs.digest }}"
          echo "$digest" > "/tmp/digests/${{ matrix.arch }}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digest-${{ matrix.arch }}
          path: /tmp/digests/${{ matrix.arch }}
          retention-days: 1

  merge-manifests:
    name: Create Multi-arch Manifest
    runs-on: ubuntu-24.04
    needs:
      - build-and-push
    steps:
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digest-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create and push manifest
        run: |
          AMD64_DIGEST=$(cat /tmp/digests/amd64)
          ARM64_DIGEST=$(cat /tmp/digests/arm64)

          docker buildx imagetools create \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${AMD64_DIGEST} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${ARM64_DIGEST}

  lint-chart:
    name: Lint Charts
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        chart:
          - minecraft-operator-crds
          - minecraft-operator
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          # renovate: datasource=github-releases depName=helm/helm
          version: "v3.19.2"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.8.0

      - name: Install tools
        run: |
          # helm-unittest
          # renovate: datasource=github-releases depName=helm-unittest/helm-unittest
          helm plugin install https://github.com/helm-unittest/helm-unittest.git --version v0.8.2

          # JSON schema validator
          pip install check-jsonschema

          # Artifact Hub CLI
          # renovate: datasource=github-releases depName=artifacthub/hub
          AH_VERSION="1.21.0"
          wget --quiet https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz
          tar --extract --gzip --file ah_${AH_VERSION}_linux_amd64.tar.gz
          chmod +x ah
          sudo mv ah /usr/local/bin/ah

          # helm-docs
          # renovate: datasource=github-releases depName=norwoodj/helm-docs
          HELM_DOCS_VERSION="1.14.2"
          wget --quiet https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          tar --extract --gzip --file helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          chmod +x helm-docs
          sudo mv helm-docs /usr/local/bin/helm-docs

          # markdownlint-cli
          npm install --global markdownlint-cli

      - name: Run Helm Lint
        run: helm lint charts/${{ matrix.chart }}

      - name: Run Helm Unittest
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if [ -d "$CHART_DIR/tests" ]; then
            helm unittest $CHART_DIR --color --with-subchart=false
          fi

      - name: Run chart-testing lint
        run: ct lint --charts charts/${{ matrix.chart }}

      - name: Run Artifact Hub Lint
        run: ah lint --kind helm --path charts/${{ matrix.chart }}

      - name: Validate JSON Schema
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if [ -f "$CHART_DIR/values.schema.json" ]; then
            check-jsonschema --schemafile "$CHART_DIR/values.schema.json" "$CHART_DIR/values.yaml"
          fi

      - name: Check README Documentation
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if [ -f "$CHART_DIR/README.md.gotmpl" ]; then
            helm-docs --chart-search-root=charts
            if ! git diff --exit-code "$CHART_DIR/README.md"; then
              echo "README.md is out of date. Please run 'helm-docs' locally and commit the changes."
              exit 1
            fi
          fi

      - name: Run Markdownlint
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if [ -f "$CHART_DIR/README.md" ]; then
            if [ -f "$CHART_DIR/.markdownlint.yaml" ]; then
              markdownlint "$CHART_DIR/README.md" --config "$CHART_DIR/.markdownlint.yaml"
            else
              markdownlint "$CHART_DIR/README.md"
            fi
          fi

      - name: Template Chart
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if grep -q "^dependencies:" "$CHART_DIR/Chart.yaml"; then
            helm dependency update "$CHART_DIR"
          fi
          helm template test-release "$CHART_DIR"

  build-chart:
    name: Build Charts
    runs-on: ubuntu-24.04
    needs:
      - security
      - lint
      - test
      - lint-chart
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          # renovate: datasource=github-releases depName=helm/helm
          version: "v3.19.2"

      - name: Install yq
        run: |
          # renovate: datasource=github-releases depName=mikefarah/yq
          YQ_VERSION="4.44.3"
          wget --quiet https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64 --output-document yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq

      - name: Modify chart versions for PR
        run: |
          PR_VERSION="0.0.0-pr.${{ github.event.pull_request.number }}"

          # Update CRD chart
          yq eval ".version = \"${PR_VERSION}\"" --inplace charts/minecraft-operator-crds/Chart.yaml
          yq eval ".appVersion = \"${PR_VERSION}\"" --inplace charts/minecraft-operator-crds/Chart.yaml

          # Update operator chart
          yq eval ".version = \"${PR_VERSION}\"" --inplace charts/minecraft-operator/Chart.yaml
          yq eval ".appVersion = \"${PR_VERSION}\"" --inplace charts/minecraft-operator/Chart.yaml
          yq eval ".dependencies[0].version = \"${PR_VERSION}\"" --inplace charts/minecraft-operator/Chart.yaml

          # Update image reference
          yq eval ".image.repository = \"${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\"" --inplace charts/minecraft-operator/values.yaml
          yq eval ".image.tag = \"latest\"" --inplace charts/minecraft-operator/values.yaml

      - name: Package charts
        run: |
          helm package charts/minecraft-operator-crds
          helm dependency update charts/minecraft-operator
          helm package charts/minecraft-operator

      - name: Push charts to ttl.sh
        run: |
          PR_VERSION="0.0.0-pr.${{ github.event.pull_request.number }}"

          helm push minecraft-operator-crds-${PR_VERSION}.tgz oci://${{ env.REGISTRY }}
          helm push minecraft-operator-${PR_VERSION}.tgz oci://${{ env.REGISTRY }}

  notify:
    name: Notify PR
    runs-on: ubuntu-24.04
    needs:
      - merge-manifests
      - build-chart
    steps:
      - name: Check for existing label
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            return labels.includes('Container Available');
          result-encoding: string

      - name: Add label and comment
        if: steps.check-label.outputs.result != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const registry = 'ttl.sh';
            const imageName = `minecraft-operator-${prNumber}-1d`;
            const chartVersion = `0.0.0-pr.${prNumber}`;

            // Add label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['Container Available']
            });

            // Add comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## Container and Helm Charts Available

            Multi-architecture container image and Helm charts are available for testing (expires in 24 hours).

            ### Pull Commands

            **Container Image:**
            \`\`\`bash
            docker pull ${registry}/${imageName}:latest
            \`\`\`

            **Helm Charts:**
            \`\`\`bash
            # Install CRDs
            helm install minecraft-operator-crds \\
              oci://${registry}/minecraft-operator-crds \\
              --version ${chartVersion}

            # Install operator
            helm install minecraft-operator \\
              oci://${registry}/minecraft-operator \\
              --version ${chartVersion}
            \`\`\`

            **Architectures:** linux/amd64, linux/arm64
            **Commit:** ${{ github.sha }}`
            });

  summary:
    name: Summary
    runs-on: ubuntu-24.04
    needs:
      - security
      - lint
      - test
      - merge-manifests
      - lint-chart
      - build-chart
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Build | ${{ needs.merge-manifests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chart Lint | ${{ needs.lint-chart.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Chart Build | ${{ needs.build-chart.result }} |" >> $GITHUB_STEP_SUMMARY
