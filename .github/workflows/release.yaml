name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  id-token: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  lint-chart:
    name: Lint Charts
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        chart:
          - minecraft-operator-crds
          - minecraft-operator
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          # renovate: datasource=github-releases depName=helm/helm
          version: "v3.17.3"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: Install tools
        run: |
          # helm-unittest
          # renovate: datasource=github-releases depName=helm-unittest/helm-unittest
          helm plugin install https://github.com/helm-unittest/helm-unittest.git --version v0.8.2

          pip install check-jsonschema

          # renovate: datasource=github-releases depName=artifacthub/hub
          AH_VERSION="1.21.0"
          wget --quiet https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz
          tar --extract --gzip --file ah_${AH_VERSION}_linux_amd64.tar.gz
          chmod +x ah
          sudo mv ah /usr/local/bin/ah

      - name: Run Helm Lint
        run: helm lint charts/${{ matrix.chart }}

      - name: Run Helm Unittest
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if [ -d "$CHART_DIR/tests" ]; then
            helm unittest $CHART_DIR --color --with-subchart=false
          fi

      - name: Run chart-testing lint
        run: ct lint --charts charts/${{ matrix.chart }}

      - name: Run Artifact Hub Lint
        run: ah lint --kind helm --path charts/${{ matrix.chart }}

  build-and-push:
    name: Build (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    needs:
      - lint-chart
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
            runner: ubuntu-24.04
          - arch: arm64
            platform: linux/arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "revision=${GITHUB_SHA}" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: Build and push by digest
        id: push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: build/Containerfile
          platforms: ${{ matrix.platform }}
          push: true
          outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            REVISION=${{ steps.version.outputs.revision }}
            BUILD_DATE=${{ steps.version.outputs.build_date }}
          cache-from: type=gha,scope=build-${{ matrix.arch }}
          cache-to: type=gha,scope=build-${{ matrix.arch }},mode=max

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.push.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.arch }}
          path: /tmp/digests/*
          retention-days: 1

  merge-manifests:
    name: Create Multi-arch Manifest
    runs-on: ubuntu-24.04
    needs:
      - build-and-push
    outputs:
      digest: ${{ steps.inspect.outputs.digest }}
    steps:
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Create and push manifest
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create \
            $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@sha256:%s ' *)

      - name: Inspect image
        id: inspect
        run: |
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          DIGEST=$(docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} --format "{{json .Manifest.Digest}}" | tr -d '"')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign container image
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.inspect.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "1"

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate SBOM
        run: |
          syft ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.inspect.outputs.digest }} \
            --output spdx-json=sbom.spdx.json

      - name: Attest SBOM
        run: |
          cosign attest --yes \
            --predicate sbom.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.inspect.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "1"

  publish-chart:
    name: Publish Charts
    runs-on: ubuntu-24.04
    needs:
      - merge-manifests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          # renovate: datasource=github-releases depName=helm/helm
          version: "v3.17.3"

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Install tools
        run: |
          # renovate: datasource=github-releases depName=mikefarah/yq
          YQ_VERSION="4.44.3"
          wget --quiet https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64 --output-document yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Get previous tag for changelog
          PREV_TAG=$(git tag --sort=-v:refname | grep -E "^v[0-9]" | sed -n '2p')
          echo "prev_tag=${PREV_TAG:-}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREV_TAG="${{ steps.version.outputs.prev_tag }}"

          # Create changelog annotation for Artifact Hub
          CHANGELOG=""

          if [ -n "$PREV_TAG" ]; then
            while IFS= read -r line; do
              if [[ "$line" =~ ^feat(\(.*\))?:\ (.*)$ ]]; then
                CHANGELOG="${CHANGELOG}- kind: added\n  description: \"${BASH_REMATCH[2]}\"\n"
              elif [[ "$line" =~ ^fix(\(.*\))?:\ (.*)$ ]]; then
                CHANGELOG="${CHANGELOG}- kind: fixed\n  description: \"${BASH_REMATCH[2]}\"\n"
              elif [[ "$line" =~ ^security(\(.*\))?:\ (.*)$ ]]; then
                CHANGELOG="${CHANGELOG}- kind: security\n  description: \"${BASH_REMATCH[2]}\"\n"
              elif [[ "$line" =~ ^(refactor|perf|build|docs)(\(.*\))?:\ (.*)$ ]]; then
                CHANGELOG="${CHANGELOG}- kind: changed\n  description: \"${BASH_REMATCH[3]}\"\n"
              fi
            done <<< "$(git log ${PREV_TAG}..HEAD --format="%s" --no-merges)"
          fi

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- kind: added\n  description: \"Release ${VERSION}\"\n"
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update chart versions
        env:
          CHANGELOG: ${{ steps.changelog.outputs.changelog }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Update CRD chart
          yq eval ".version = \"${VERSION}\"" --inplace charts/minecraft-operator-crds/Chart.yaml
          yq eval ".appVersion = \"${VERSION}\"" --inplace charts/minecraft-operator-crds/Chart.yaml

          # Update operator chart
          yq eval ".version = \"${VERSION}\"" --inplace charts/minecraft-operator/Chart.yaml
          yq eval ".appVersion = \"${VERSION}\"" --inplace charts/minecraft-operator/Chart.yaml
          yq eval ".dependencies[0].version = \"${VERSION}\"" --inplace charts/minecraft-operator/Chart.yaml

          # Add changelog annotation
          if [ -n "$CHANGELOG" ]; then
            yq eval '.annotations."artifacthub.io/changes" = strenv(CHANGELOG)' --inplace charts/minecraft-operator/Chart.yaml
          fi

          # Update image tag
          yq eval ".image.tag = \"${VERSION}\"" --inplace charts/minecraft-operator/values.yaml

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package and push CRD chart
        id: push-crds
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          helm package charts/minecraft-operator-crds

          helm push minecraft-operator-crds-${VERSION}.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}

          # Get digest for signing
          DIGEST=$(oras manifest fetch ${{ env.REGISTRY }}/${{ github.repository_owner }}/minecraft-operator-crds:${VERSION} --descriptor | jq -r '.digest')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Package and push operator chart
        id: push-operator
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          helm dependency update charts/minecraft-operator
          helm package charts/minecraft-operator

          helm push minecraft-operator-${VERSION}.tgz oci://${{ env.REGISTRY }}/${{ github.repository_owner }}

          # Get digest for signing
          DIGEST=$(oras manifest fetch ${{ env.REGISTRY }}/${{ github.repository_owner }}/minecraft-operator:${VERSION} --descriptor | jq -r '.digest')
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Publish Artifact Hub metadata
        run: |
          for chart in minecraft-operator-crds minecraft-operator; do
            CHART_PATH="charts/${chart}"
            if [ -f "${CHART_PATH}/artifacthub-repo.yml" ]; then
              oras push \
                ${{ env.REGISTRY }}/${{ github.repository_owner }}/${chart}:artifacthub.io \
                --config /dev/null:application/vnd.cncf.artifacthub.config.v1+yaml \
                ${CHART_PATH}/artifacthub-repo.yml:application/vnd.cncf.artifacthub.repository-metadata.layer.v1.yaml
            fi
          done

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign CRD chart
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ github.repository_owner }}/minecraft-operator-crds@${{ steps.push-crds.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "1"

      - name: Sign operator chart
        run: |
          cosign sign --yes ${{ env.REGISTRY }}/${{ github.repository_owner }}/minecraft-operator@${{ steps.push-operator.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "1"

      - name: Upload chart artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helm-charts
          path: "*.tgz"
          retention-days: 5

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-24.04
    needs:
      - merge-manifests
      - publish-chart
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download chart artifacts
        uses: actions/download-artifact@v4
        with:
          name: helm-charts
          path: ./charts-dist

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          PREV_TAG=$(git tag --sort=-v:refname | grep -E "^v[0-9]" | sed -n '2p')
          echo "prev_tag=${PREV_TAG:-}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREV_TAG="${{ steps.version.outputs.prev_tag }}"
          DIGEST="${{ needs.merge-manifests.outputs.digest }}"

          cat << EOF > release-notes.md
          ## Minecraft Operator v${VERSION}

          Kubernetes operator for managing PaperMC servers with automatic plugin and version management.

          ### Container Image

          \`\`\`bash
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}
          \`\`\`

          **Digest:** \`${DIGEST}\`

          **Architectures:** linux/amd64, linux/arm64

          ### Verify Signatures

          \`\`\`bash
          # Verify container image
          cosign verify ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION} \\
            --certificate-identity-regexp=https://github.com/${{ github.repository }} \\
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com

          # Verify SBOM attestation
          cosign verify-attestation ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION} \\
            --type spdxjson \\
            --certificate-identity-regexp=https://github.com/${{ github.repository }} \\
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com
          \`\`\`

          ### Helm Charts

          \`\`\`bash
          # Install CRDs
          helm install minecraft-operator-crds \\
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/minecraft-operator-crds \\
            --version ${VERSION} \\
            --namespace minecraft-operator-system \\
            --create-namespace

          # Install operator
          helm install minecraft-operator \\
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/minecraft-operator \\
            --version ${VERSION} \\
            --namespace minecraft-operator-system
          \`\`\`

          EOF

          # Add changelog if previous tag exists
          if [ -n "$PREV_TAG" ]; then
            echo "### Changes since ${PREV_TAG}" >> release-notes.md
            echo "" >> release-notes.md
            git log ${PREV_TAG}..HEAD --format="- %s" --no-merges >> release-notes.md
          fi

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          gh release create "v${VERSION}" \
            --title "v${VERSION}" \
            --notes-file release-notes.md \
            ./charts-dist/*.tgz

  summary:
    name: Summary
    runs-on: ubuntu-24.04
    needs:
      - merge-manifests
      - publish-chart
      - create-release
    if: always()
    steps:
      - name: Create summary
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Container Image | ${{ needs.merge-manifests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Helm Charts | ${{ needs.publish-chart.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Container: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- CRD Chart: \`oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/minecraft-operator-crds:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Operator Chart: \`oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/minecraft-operator:${VERSION}\`" >> $GITHUB_STEP_SUMMARY
