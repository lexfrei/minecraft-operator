name: Publish Charts to OCI

on:
  push:
    branches:
      - master
    paths:
      - 'charts/**'
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      publish_crds: ${{ steps.detect.outputs.publish_crds }}
      publish_operator: ${{ steps.detect.outputs.publish_operator }}
      crds_version: ${{ steps.detect.outputs.crds_version }}
      operator_version: ${{ steps.detect.outputs.operator_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install yq
        run: |
          # renovate: datasource=github-releases depName=mikefarah/yq
          YQ_VERSION="4.44.3"
          wget --quiet https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64 --output-document yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq
          yq --version

      - name: Detect if charts need publishing
        id: detect
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check CRD chart
          CRDS_VERSION=$(yq eval '.version' "charts/minecraft-operator-crds/Chart.yaml")
          CRDS_TAG="minecraft-operator-crds-${CRDS_VERSION}"

          if gh release view "$CRDS_TAG" >/dev/null 2>&1; then
            echo "publish_crds=false" >> "$GITHUB_OUTPUT"
            echo "CRD chart $CRDS_TAG already exists"
          else
            echo "publish_crds=true" >> "$GITHUB_OUTPUT"
            echo "CRD chart $CRDS_TAG needs publishing"
          fi
          echo "crds_version=$CRDS_VERSION" >> "$GITHUB_OUTPUT"

          # Check operator chart
          OPERATOR_VERSION=$(yq eval '.version' "charts/minecraft-operator/Chart.yaml")
          OPERATOR_TAG="minecraft-operator-${OPERATOR_VERSION}"

          if gh release view "$OPERATOR_TAG" >/dev/null 2>&1; then
            echo "publish_operator=false" >> "$GITHUB_OUTPUT"
            echo "Operator chart $OPERATOR_TAG already exists"
          else
            echo "publish_operator=true" >> "$GITHUB_OUTPUT"
            echo "Operator chart $OPERATOR_TAG needs publishing"
          fi
          echo "operator_version=$OPERATOR_VERSION" >> "$GITHUB_OUTPUT"

  publish-crds:
    needs: detect-changes
    if: needs.detect-changes.outputs.publish_crds == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Install tools
        run: |
          # renovate: datasource=github-releases depName=mikefarah/yq
          YQ_VERSION="4.44.3"
          wget --quiet https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64 --output-document yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq

          # renovate: datasource=github-releases depName=artifacthub/hub
          AH_VERSION="1.21.0"
          wget --quiet https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz
          tar --extract --gzip --file ah_${AH_VERSION}_linux_amd64.tar.gz
          chmod +x ah
          sudo mv ah /usr/local/bin/ah

          pip install check-jsonschema

      - name: Run validation tests
        run: |
          CHART_PATH="charts/minecraft-operator-crds"

          helm lint "${CHART_PATH}"

          if [ -f "${CHART_PATH}/values.schema.json" ]; then
            check-jsonschema --schemafile "${CHART_PATH}/values.schema.json" "${CHART_PATH}/values.yaml"
          fi

          ah lint --kind helm --path "${CHART_PATH}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package and push chart
        run: |
          CHART_PATH="charts/minecraft-operator-crds"
          CHART_NAME="minecraft-operator-crds"
          CHART_VERSION="${{ needs.detect-changes.outputs.crds_version }}"

          helm package "${CHART_PATH}"
          helm push "${CHART_NAME}-${CHART_VERSION}.tgz" oci://ghcr.io/${{ github.repository_owner }}

      - name: Publish Artifact Hub metadata
        run: |
          CHART_PATH="charts/minecraft-operator-crds"
          CHART_NAME="minecraft-operator-crds"

          if [ -f "${CHART_PATH}/artifacthub-repo.yml" ]; then
            oras push \
              ghcr.io/${{ github.repository_owner }}/${CHART_NAME}:artifacthub.io \
              --config /dev/null:application/vnd.cncf.artifacthub.config.v1+yaml \
              ${CHART_PATH}/artifacthub-repo.yml:application/vnd.cncf.artifacthub.repository-metadata.layer.v1.yaml
          fi

      - name: Create GitHub Release
        run: |
          CHART_VERSION="${{ needs.detect-changes.outputs.crds_version }}"
          CHART_NAME="minecraft-operator-crds"

          gh release create "${CHART_NAME}-${CHART_VERSION}" \
            --title "minecraft-operator-crds v${CHART_VERSION}" \
            --notes "## CRD Chart v${CHART_VERSION}

          Custom Resource Definitions for Minecraft Operator.

          ### Installation

          \`\`\`bash
          helm install minecraft-operator-crds \\
            oci://ghcr.io/${{ github.repository_owner }}/minecraft-operator-crds \\
            --version ${CHART_VERSION} \\
            --namespace minecraft-operator-system \\
            --create-namespace
          \`\`\`

          ðŸ“¦ **Published to**: \`ghcr.io/${{ github.repository_owner }}/minecraft-operator-crds:${CHART_VERSION}\`" \
            "${CHART_NAME}-${CHART_VERSION}.tgz"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-operator:
    needs:
      - detect-changes
      - publish-crds
    if: |
      always() &&
      needs.detect-changes.outputs.publish_operator == 'true' &&
      (needs.publish-crds.result == 'success' || needs.publish-crds.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: latest

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Install tools
        run: |
          # renovate: datasource=github-releases depName=mikefarah/yq
          YQ_VERSION="4.44.3"
          wget --quiet https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64 --output-document yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq

          # renovate: datasource=github-releases depName=artifacthub/hub
          AH_VERSION="1.21.0"
          wget --quiet https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz
          tar --extract --gzip --file ah_${AH_VERSION}_linux_amd64.tar.gz
          chmod +x ah
          sudo mv ah /usr/local/bin/ah

          pip install check-jsonschema

      - name: Run validation tests
        run: |
          CHART_PATH="charts/minecraft-operator"

          helm dependency update "${CHART_PATH}"
          helm lint "${CHART_PATH}"

          if [ -f "${CHART_PATH}/values.schema.json" ]; then
            check-jsonschema --schemafile "${CHART_PATH}/values.schema.json" "${CHART_PATH}/values.yaml"
          fi

          ah lint --kind helm --path "${CHART_PATH}"

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Package and push chart
        run: |
          CHART_PATH="charts/minecraft-operator"
          CHART_NAME="minecraft-operator"
          CHART_VERSION="${{ needs.detect-changes.outputs.operator_version }}"

          helm package "${CHART_PATH}"
          helm push "${CHART_NAME}-${CHART_VERSION}.tgz" oci://ghcr.io/${{ github.repository_owner }}

      - name: Publish Artifact Hub metadata
        run: |
          CHART_PATH="charts/minecraft-operator"
          CHART_NAME="minecraft-operator"

          if [ -f "${CHART_PATH}/artifacthub-repo.yml" ]; then
            oras push \
              ghcr.io/${{ github.repository_owner }}/${CHART_NAME}:artifacthub.io \
              --config /dev/null:application/vnd.cncf.artifacthub.config.v1+yaml \
              ${CHART_PATH}/artifacthub-repo.yml:application/vnd.cncf.artifacthub.repository-metadata.layer.v1.yaml
          fi

      - name: Create GitHub Release
        run: |
          CHART_VERSION="${{ needs.detect-changes.outputs.operator_version }}"
          CHART_NAME="minecraft-operator"

          gh release create "${CHART_NAME}-${CHART_VERSION}" \
            --title "minecraft-operator v${CHART_VERSION}" \
            --notes "## Minecraft Operator v${CHART_VERSION}

          Kubernetes operator for managing PaperMC servers with automatic plugin and version management.

          ### Installation

          \`\`\`bash
          # Install CRDs first
          helm install minecraft-operator-crds \\
            oci://ghcr.io/${{ github.repository_owner }}/minecraft-operator-crds \\
            --version ${{ needs.detect-changes.outputs.crds_version }} \\
            --namespace minecraft-operator-system \\
            --create-namespace

          # Install operator
          helm install minecraft-operator \\
            oci://ghcr.io/${{ github.repository_owner }}/minecraft-operator \\
            --version ${CHART_VERSION} \\
            --namespace minecraft-operator-system
          \`\`\`

          Or install with automatic CRD installation:

          \`\`\`bash
          helm install minecraft-operator \\
            oci://ghcr.io/${{ github.repository_owner }}/minecraft-operator \\
            --version ${CHART_VERSION} \\
            --namespace minecraft-operator-system \\
            --create-namespace
          \`\`\`

          ðŸ“¦ **Published to**: \`ghcr.io/${{ github.repository_owner }}/minecraft-operator:${CHART_VERSION}\`" \
            "${CHART_NAME}-${CHART_VERSION}.tgz"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸš€ Charts Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CRD Chart" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.detect-changes.outputs.crds_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`ghcr.io/${{ github.repository_owner }}/minecraft-operator-crds\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Operator Chart" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.detect-changes.outputs.operator_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`ghcr.io/${{ github.repository_owner }}/minecraft-operator\`" >> $GITHUB_STEP_SUMMARY
