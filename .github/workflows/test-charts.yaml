name: Lint and Test Charts

on:
  pull_request:
  push:
    branches:
      - master
    paths:
      - 'charts/**'
  workflow_dispatch:

jobs:
  lint-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart:
          - minecraft-operator-crds
          - minecraft-operator
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: Install tools
        run: |
          # helm-unittest
          helm plugin install https://github.com/helm-unittest/helm-unittest.git

          # JSON schema validator
          pip install check-jsonschema

          # Artifact Hub CLI
          # renovate: datasource=github-releases depName=artifacthub/hub
          AH_VERSION="1.21.0"
          wget --quiet https://github.com/artifacthub/hub/releases/download/v${AH_VERSION}/ah_${AH_VERSION}_linux_amd64.tar.gz
          tar --extract --gzip --file ah_${AH_VERSION}_linux_amd64.tar.gz
          chmod +x ah
          sudo mv ah /usr/local/bin/ah

          # helm-docs
          # renovate: datasource=github-releases depName=norwoodj/helm-docs
          HELM_DOCS_VERSION="1.14.2"
          wget --quiet https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          tar --extract --gzip --file helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          chmod +x helm-docs
          sudo mv helm-docs /usr/local/bin/helm-docs

          # markdownlint-cli
          npm install --global markdownlint-cli

      - name: Run Helm Lint
        run: |
          echo "ðŸ” Running Helm lint for ${{ matrix.chart }}..."
          helm lint charts/${{ matrix.chart }}

      - name: Run Helm Unittest
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if [ -d "$CHART_DIR/tests" ]; then
            echo "ðŸ§ª Running unit tests for ${{ matrix.chart }}..."
            helm unittest $CHART_DIR --color --with-subchart=false
          else
            echo "â„¹ï¸  No tests directory found for ${{ matrix.chart }}, skipping unit tests"
          fi

      - name: Run chart-testing (lint)
        run: |
          echo "ðŸ“‹ Running chart-testing lint for ${{ matrix.chart }}..."
          ct lint --charts charts/${{ matrix.chart }}

      - name: Run Artifact Hub Lint
        run: |
          echo "ðŸ›ï¸  Running Artifact Hub lint for ${{ matrix.chart }}..."
          ah lint --kind helm --path charts/${{ matrix.chart }}

      - name: Validate JSON Schema
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if [ -f "$CHART_DIR/values.schema.json" ]; then
            echo "ðŸ“ Validating values.yaml against schema for ${{ matrix.chart }}..."
            check-jsonschema --schemafile "$CHART_DIR/values.schema.json" "$CHART_DIR/values.yaml"
          else
            echo "â„¹ï¸  No values.schema.json found for ${{ matrix.chart }}, skipping schema validation"
          fi

      - name: Check README Documentation
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if [ -f "$CHART_DIR/README.md.gotmpl" ]; then
            echo "ðŸ“š Checking if README.md is up to date for ${{ matrix.chart }}..."
            helm-docs --chart-search-root=charts
            if ! git diff --exit-code "$CHART_DIR/README.md"; then
              echo "âŒ README.md is out of date. Please run 'helm-docs charts/${{ matrix.chart }}' locally and commit the changes."
              exit 1
            else
              echo "âœ… README.md is up to date for ${{ matrix.chart }}"
            fi
          else
            echo "â„¹ï¸  No README.md.gotmpl found for ${{ matrix.chart }}, skipping README check"
          fi

      - name: Run Markdownlint
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          if [ -f "$CHART_DIR/README.md" ]; then
            echo "ðŸ“ Running markdownlint on README.md for ${{ matrix.chart }}..."
            if [ -f "$CHART_DIR/.markdownlint.yaml" ]; then
              markdownlint "$CHART_DIR/README.md" --config "$CHART_DIR/.markdownlint.yaml"
            else
              markdownlint "$CHART_DIR/README.md"
            fi
          else
            echo "â„¹ï¸  No README.md found for ${{ matrix.chart }}, skipping markdownlint"
          fi

      - name: Template Chart
        run: |
          CHART_DIR="charts/${{ matrix.chart }}"
          echo "ðŸ”¨ Testing chart templating for ${{ matrix.chart }}..."

          # Update dependencies if Chart.yaml has dependencies
          if grep -q "^dependencies:" "$CHART_DIR/Chart.yaml"; then
            echo "ðŸ“¦ Updating chart dependencies..."
            helm dependency update "$CHART_DIR"
          fi

          helm template test-release "$CHART_DIR"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results for ${{ matrix.chart }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All validation tests completed" >> $GITHUB_STEP_SUMMARY
