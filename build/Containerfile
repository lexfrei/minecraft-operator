FROM docker.io/library/golang:1.25.3-alpine3.22 AS build

RUN echo 'nobody:x:65534:65534:Nobody:/:' > /tmp/passwd && \
    apk add --no-cache upx=5.0.2-r0

WORKDIR /workspace
COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -ldflags="-s -w" -o manager ./cmd/main.go && \
    upx --best --lzma manager

FROM scratch

COPY --from=build /tmp/passwd /etc/passwd
COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/
COPY --from=build /workspace/manager /

USER 65534

LABEL org.opencontainers.image.title="Minecraft Operator"
LABEL org.opencontainers.image.description="Kubernetes operator for managing PaperMC Minecraft servers"
LABEL org.opencontainers.image.source="https://github.com/lexfrei/minecraft-operator"
LABEL org.opencontainers.image.licenses="BSD-3-Clause"
LABEL org.opencontainers.image.vendor="Aleksei Sviridkin"
LABEL maintainer="f@lex.la"

ENTRYPOINT ["/manager"]
