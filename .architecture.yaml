metadata:
  repository:
    name: "minecraft-operator"
    type: "application"
    description: "Kubernetes operator for managing PaperMC Minecraft servers with automatic version management"
    owner: "f@lex.la"
    maintainer:
      name: "Aleksei Sviridkin"
      email: "f@lex.la"
      gpg: "F57F 85FC 7975 F22B BC3F 2504 9C17 3EB1 B531 AA1F"
      role: "SRE"
  language:
    primary: "go"
    version: "1.25"  # Go 1.25+ required for controller-runtime v0.22
  version: "1.3.0"  # .architecture.yaml version (MINOR: Version management constraints)
  last_updated: "2025-11-02"
  license: "BSD-3-Clause"

technical_stack:
  language:
    primary: "go"
    version: "1.25"
    module_path: "github.com/lexfrei/minecraft-operator"

  kubernetes:
    api_group: "mc.k8s.lex.la"
    api_version: "v1alpha1"
    min_k8s_version: "1.27"
    target_k8s_version: "1.34"
    scope: "namespace"  # All CRDs are namespace-scoped

  frameworks:
    operator: "sigs.k8s.io/controller-runtime"
    operator_version: "v0.22.3"  # Latest stable (Oct 2025)
    kubebuilder: "kubebuilder.io/v4"
    kubebuilder_version: "4.9.0"

  core_dependencies:
    client_go: "k8s.io/client-go"
    client_go_version: "v0.34.0"  # Matches controller-runtime v0.22
    apimachinery: "k8s.io/apimachinery"
    apimachinery_version: "v0.34.0"
    api: "k8s.io/api"
    api_version: "v0.34.0"

  external_libraries:
    hangar_client:
      package: "github.com/lexfrei/go-hungar"
      version: "latest"  # Use latest stable
      purpose: "Hangar API client for PaperMC plugin repository"

    cron:
      package: "github.com/robfig/cron/v3"
      version: "v3.0.1"
      purpose: "Cron scheduling for maintenance windows"

    semver:
      package: "github.com/Masterminds/semver/v3"
      version: "v3.3.0"
      purpose: "Semantic version comparison and constraints"

    rcon:
      package: "github.com/gorcon/rcon"
      version: "v1.3.5"
      purpose: "RCON protocol implementation for graceful server shutdown"

    errors:
      package: "github.com/cockroachdb/errors"
      version: "v1.11.3"
      purpose: "Enhanced error handling with stack traces"

    registry:
      package: "net/http (stdlib)"
      version: "stdlib"
      purpose: "Docker Hub Registry API v2 client for image verification"

    templ:
      package: "github.com/a-h/templ"
      version: "v0.3.960"
      purpose: "Type-safe HTML templates compiled to Go code for Web UI"

    htmx:
      type: "static-asset"
      version: "1.9.12"
      cdn: "https://unpkg.com/htmx.org@1.9.12"
      purpose: "Dynamic HTML updates via SSE and AJAX for Web UI"

  testing:
    framework: "testing (stdlib)"
    envtest: "sigs.k8s.io/controller-runtime/pkg/envtest"
    envtest_version: "v0.22.3"
    ginkgo: "github.com/onsi/ginkgo/v2"
    ginkgo_version: "v2.20.2"
    gomega: "github.com/onsi/gomega"
    gomega_version: "v1.34.2"
    coverage_target: "80%"

infrastructure:
  containerization:
    tool: "podman"  # Primary container runtime per global CLAUDE.md
    base_image_build: "golang:1.25-alpine"
    base_image_runtime: "gcr.io/distroless/static-debian12:nonroot"
    security:
      - "Non-root user (uid 65532)"
      - "No shell access"
      - "Minimal attack surface"
      - "No package manager"
    registry: "ghcr.io/lexfrei/minecraft-operator"
    image_tags:
      - "Use semantic versioning"
      - "Never use 'latest' in production"
      - "SHA256 digest pinning for dependencies"

  kubernetes:
    resource_type: "StatefulSet"  # For PaperMC server pods (persistent state)
    operator_resource: "Deployment"  # For operator itself
    storage: "PVC"  # PersistentVolumeClaim for world data and plugins
    patterns:
      - "StatefulSet with PVC for game servers"
      - "plugins/update/ folder for hot-swap"
      - "terminationGracePeriodSeconds: 300 (5 minutes minimum)"
    security:
      - "securityContext with readOnlyRootFilesystem where possible"
      - "Resource limits and requests"
      - "RCON password via Secret"
      - "No privileged containers"

  external_images:
    papermc:
      image: "docker.io/lexfrei/papermc:latest"
      registry: "Docker Hub"
      source: "https://github.com/lexfrei/papermc-docker"
      customizable: true
      purpose: "Base PaperMC server image for StatefulSets"

  helm:
    api_version: "v2"
    charts:
      - name: "minecraft-operator-crds"
        path: "charts/minecraft-operator-crds"
        lifecycle: "independent"
        purpose: "CRD definitions (separate lifecycle from operator)"

      - name: "minecraft-operator"
        path: "charts/minecraft-operator"
        depends_on: "minecraft-operator-crds"
        condition: "crds.enabled"
        purpose: "Operator deployment with optional CRD installation"

    min_k8s_version: "1.27"
    default_resources:
      operator:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"

  ci_cd:
    platform: "GitHub Actions"
    registry: "ghcr.io"
    workflows:
      - "Linting (golangci-lint)"
      - "Unit tests"
      - "Integration tests (envtest)"
      - "Container image build"
      - "Helm chart linting"
      - "Security scanning"

structure:
  layout: "helm-first-kubebuilder"
  deployment_method: "helm-only"
  organization:
    api:
      - "api/v1alpha1/ - CRD type definitions"
      - "plugin_types.go - Plugin CRD"
      - "papermcserver_types.go - PaperMCServer CRD"
      - "zz_generated.deepcopy.go - Generated code"

    controllers:
      - "internal/controller/plugin_controller.go - Plugin reconciliation"
      - "internal/controller/papermcserver_controller.go - PaperMCServer reconciliation"
      - "internal/controller/update_controller.go - Maintenance window updates"

    pkg:
      - "pkg/solver/ - Constraint solver implementation"
      - "pkg/solver/solver.go - Solver interface"
      - "pkg/solver/simple_solver.go - Linear search MVP implementation"
      - "pkg/plugins/ - Plugin repository clients"
      - "pkg/plugins/client.go - Common interface"
      - "pkg/plugins/hangar.go - Hangar API client (using go-hungar)"
      - "pkg/plugins/cache.go - API response caching"
      - "pkg/paper/ - Paper API client"
      - "pkg/paper/client.go - Paper version fetching"
      - "pkg/registry/ - Docker Hub Registry API client"
      - "pkg/registry/client.go - Docker Hub tag listing and verification"
      - "pkg/registry/types.go - Docker Hub API response types"
      - "pkg/rcon/ - RCON integration"
      - "pkg/rcon/client.go - RCON client wrapper"
      - "pkg/selector/ - Label selector matching"
      - "pkg/selector/matcher.go - Selector logic"
      - "pkg/webui/ - Web UI server and handlers"
      - "pkg/webui/server.go - HTTP server setup"
      - "pkg/webui/handlers.go - Request handlers"
      - "pkg/webui/sse.go - Server-Sent Events for live updates"
      - "pkg/webui/templates/ - Templ template files"
      - "pkg/webui/templates/layout.templ - Base HTML layout"
      - "pkg/webui/templates/dashboard.templ - Dashboard view"
      - "pkg/webui/templates/server.templ - Server details view"
      - "pkg/webui/static/ - Static assets (CSS, embedded HTMX)"

    charts:
      - "charts/minecraft-operator-crds/ - CRD Helm chart (independent lifecycle)"
      - "charts/minecraft-operator-crds/crds/ - Generated CRD YAML (controller-gen output)"
      - "charts/minecraft-operator/ - Operator Helm chart"
      - "charts/minecraft-operator/templates/ - K8s resources (Deployment, RBAC, Service)"
      - "charts/minecraft-operator/templates/rbac/ - Generated RBAC manifests"

    examples:
      - "examples/ - Example custom resources for testing"

    root:
      - "cmd/main.go - Operator entrypoint"
      - "build/Containerfile - Container image definition"
      - "Makefile - Build automation"
      - ".architecture.yaml - This file (single source of truth)"

custom_resources:
  plugin:
    group: "mc.k8s.lex.la"
    version: "v1alpha1"
    kind: "Plugin"
    scope: "Namespaced"
    description: "Plugin definition with source and versioning policy"
    key_fields:
      - "source.type - hangar/modrinth/spigot/url"
      - "source.project - Plugin project identifier"
      - "versionPolicy - latest or pinned"
      - "pinnedVersion - Specific version if pinned"
      - "updateDelay - Grace period before auto-apply (e.g., 168h)"
      - "instanceSelector - Label selector for PaperMCServer matching"
      - "compatibilityOverride - Manual compatibility specification"
    status_fields:
      - "resolvedVersion - Constraint solver result"
      - "availableVersions - Cached metadata (for orphaned fallback)"
      - "matchedInstances - List of matched servers"
      - "repositoryStatus - available/unavailable/orphaned"

  papermcserver:
    group: "mc.k8s.lex.la"
    version: "v1alpha1"
    kind: "PaperMCServer"
    scope: "Namespaced"
    description: "Minecraft server instance with automatic updates"
    key_fields:
      - "paperVersion - latest or specific version"
      - "updateDelay - Grace period before Paper updates"
      - "updateSchedule.checkCron - Daily update check schedule"
      - "updateSchedule.maintenanceWindow.cron - Update application schedule"
      - "gracefulShutdown.timeout - Must match terminationGracePeriodSeconds"
      - "rcon - RCON configuration for graceful shutdown"
      - "podTemplate - StatefulSet pod specification"
    status_fields:
      - "currentPaperVersion - Observed running version"
      - "currentPaperBuild - Observed running build number"
      - "desiredPaperVersion - Target Paper version"
      - "desiredPaperBuild - Target Paper build number"
      - "plugins - Matched Plugin resources with current/desired versions"
      - "availableUpdate - Solver result for next update"
      - "lastUpdate - History of previous update"
      - "updateBlocked - Update blocking information (blocked bool, reason string, blockedBy)"

environment_variables:
  # RCON Configuration (per-server, from Secret)
  RCON_PASSWORD: "RCON password from Secret"

  # Operator Configuration (optional)
  ENABLE_WEBHOOKS: "Enable admission webhooks (future)"
  METRICS_BIND_ADDRESS: "Metrics server bind address (:8080)"
  HEALTH_PROBE_BIND_ADDRESS: "Health probe bind address (:8081)"
  LEADER_ELECT: "Enable leader election (true)"

  # Web UI Configuration (optional)
  WEBUI_BIND_ADDRESS: "Web UI server bind address (:8082)"
  WEBUI_NAMESPACE: "Namespace to display in UI (defaults to operator namespace)"
  WEBUI_ENABLED: "Enable Web UI server (true by default)"

  # API Rate Limiting (optional)
  HANGAR_API_RATE_LIMIT: "Hangar API rate limit (requests/minute)"
  CACHE_TTL: "API response cache TTL (1h default)"

standards:
  naming:
    style: "Go conventions"
    crds: "CamelCase kinds, kebab-case in YAML"
    packages: "lowercase, no underscores"
    files: "snake_case for multi-word files"

  errors:
    library: "github.com/cockroachdb/errors"
    pattern: "Always wrap with errors.Wrap(err, 'context')"
    logging: "Log errors at appropriate level"

  logging:
    library: "controller-runtime logger (logr)"
    format: "Structured logging"
    pattern: "Use logger.Info/Error with key-value pairs"

  testing:
    style: "Table-driven tests"
    coverage: ">80% for pkg/"
    integration: "Use envtest for controller tests"
    mocking: "Minimal mocking, prefer real Kubernetes API via envtest"

  reconciliation:
    pattern: "Idempotent reconcile loops"
    errors: "Return error to trigger requeue"
    status: "Always update status subresource"
    finalizers: "Use finalizers for cleanup"

  versioning:
    scheme: "Semantic Versioning 2.0.0"
    api: "CRD versions follow Kubernetes conventions (v1alpha1, v1beta1, v1)"

  git:
    workflow: "Feature branches + Pull Requests"
    branch_protection: "Never commit directly to main/master"
    commit_signing: "GPG signing required"
    commit_format: "Semantic commit messages with Claude attribution"

linting:
  go:
    tool: "golangci-lint"
    config: ".golangci.yaml"
    rules:
      - "ALL linting errors must be fixed before push"
      - "No exceptions for 'cosmetic' or 'minor' errors"
      - "Modify config if rules conflict with project needs"
    enabled_linters:
      - "gofmt"
      - "goimports"
      - "govet"
      - "staticcheck"
      - "unused"
      - "gosimple"
      - "ineffassign"
      - "godot"  # Comment punctuation
      - "funlen"  # Function length
      - "cyclop"  # Cyclomatic complexity

  markdown:
    tool: "markdownlint"
    config: ".markdownlint.yaml"

  helm:
    tool: "helm lint"
    validate: "Kubernetes schema validation"

security:
  secrets:
    storage: "Kubernetes Secrets"
    pattern: "Never commit secrets to git"
    rcon: "RCON passwords via Secret with key reference"

  rbac:
    principle: "Least privilege"
    resources:
      - "Plugin and PaperMCServer CRDs (full access)"
      - "StatefulSets (full access for managed servers)"
      - "Pods (read, delete for updates)"
      - "PVCs (read, create, update)"
      - "Secrets (read only for RCON passwords)"
      - "Events (create for status reporting)"

  network:
    operator_egress:
      - "Kubernetes API Server"
      - "Hangar API (hangar.papermc.io)"
      - "Modrinth API (future)"
      - "Paper API (papermc.io)"
      - "RCON port on managed pods (25575)"

    webui_ingress:
      - "Browser clients (via kubectl port-forward or Ingress)"
      - "No authentication required by default"
      - "Production: Use Ingress with oauth2-proxy or similar"

  container:
    user: "non-root (65532)"
    capabilities: "drop ALL"
    readonly_root: "true (where possible)"

webui:
  architecture:
    pattern: "Embedded HTTP server in operator binary"
    framework: "net/http (stdlib) with github.com/a-h/templ"
    port: 8082
    authentication: "None for MVP (network policies)"

  components:
    server: "pkg/webui/server.go - HTTP server setup and routing"
    handlers: "pkg/webui/handlers.go - Request handlers for routes"
    sse: "pkg/webui/sse.go - Server-Sent Events for live updates"
    templates: "pkg/webui/templates/*.templ - Type-safe HTML templates"
    static: "pkg/webui/static/ - CSS and embedded JavaScript (HTMX)"

  routes:
    - path: "/ui"
      method: "GET"
      description: "Dashboard with all PaperMCServer instances"

    - path: "/ui/server/{name}"
      method: "GET"
      description: "Server details page with plugins and status"

    - path: "/ui/events"
      method: "GET"
      description: "SSE endpoint for real-time updates (K8s watch)"

    - path: "/ui/static/*"
      method: "GET"
      description: "Static assets (CSS, embedded HTMX script)"

  data_flow:
    - "Browser → GET /ui → server.go handler"
    - "handler → K8s client (shared cache) → fetch PaperMCServer/Plugin CRs"
    - "handler → templates.Dashboard(data) → rendered HTML"
    - "Browser ← HTML with HTMX + SSE connection"
    - "Browser → SSE connection → /ui/events"
    - "sse.go → K8s watch API → stream updates"
    - "sse.go → format as SSE events → Browser"
    - "HTMX receives SSE → triggers partial page update"

  sse_implementation:
    watch_resources:
      - "PaperMCServer (status changes)"
      - "Plugin (resolvedVersion changes)"
    event_format: "SSE (text/event-stream)"
    reconnection: "Automatic via browser SSE API"
    filtering: "Only send updates for displayed namespace"

  styling:
    approach: "Minimal embedded CSS"
    framework: "None (vanilla CSS)"
    responsive: "Basic mobile support"
    theme: "Dark mode friendly"

  performance:
    caching: "Uses operator's informer cache (no additional load)"
    connections: "One SSE connection per browser tab"
    updates: "Only send changes (not full state)"

  deployment:
    service_type: "ClusterIP (default)"
    service_port: 8082
    ingress: "Optional via Helm values (webui.ingress.enabled)"
    local_access: "kubectl port-forward svc/minecraft-operator 8082:8082"

  future_enhancements:
    - "Namespace selector dropdown"
    - "K8s RBAC authentication via SubjectAccessReview"
    - "Search and filtering"
    - "Plugin version comparison view"
    - "Manual update triggering (with confirmation)"
    - "Event log viewer"

decisions:
  - id: ADR-001
    date: 2025-10-31
    status: accepted
    decision: "Use controller-runtime v0.22.3 as operator framework"
    reasoning: "Latest stable version (Oct 2025), supports k8s.io/* v0.34, requires Go 1.25 which we have"
    alternatives:
      - "controller-runtime v0.21.x: Older, supports k8s v0.33"
      - "Operator SDK: Higher level but less flexible, controller-runtime is more direct"
    impact: "All controller code, main.go, dependencies"

  - id: ADR-002
    date: 2025-10-31
    status: accepted
    decision: "Use github.com/gorcon/rcon for RCON client"
    reasoning: "Clean Go library implementing Source RCON Protocol, actively maintained, supports Minecraft"
    alternatives:
      - "github.com/itzg/rcon-cli: CLI tool not library"
      - "james4k/rcon: Older, less maintained"
      - "Custom implementation: Unnecessary complexity"
    impact: "pkg/rcon/, graceful shutdown implementation"

  - id: ADR-003
    date: 2025-10-31
    status: accepted
    decision: "Use Masterminds/semver/v3 for version comparison"
    reasoning: "Industry standard, mature, supports constraints and ranges, v3 is latest"
    alternatives:
      - "hashicorp/go-version: Good but less features"
      - "stdlib version: Too basic"
      - "Custom parser: Error-prone"
    impact: "pkg/version/, constraint solver, all version comparisons"

  - id: ADR-004
    date: 2025-10-31
    status: accepted
    decision: "Use robfig/cron/v3 for maintenance window scheduling"
    reasoning: "Standard Go cron library, v3 has context support, well-tested"
    alternatives:
      - "K8s CronJob: External resource, harder to coordinate with reconciliation"
      - "time.Ticker: Too basic, no cron syntax"
    impact: "controllers/update_controller.go, maintenance window implementation"

  - id: ADR-005
    date: 2025-10-31
    status: accepted
    decision: "Helm-only deployment with separate CRD chart (no Kustomize)"
    reasoning: "CRDs have different upgrade/delete implications than operator, follows Helm best practices. Helm-only simplifies deployment methods and avoids maintaining dual infrastructure."
    alternatives:
      - "Kustomize: More Kubernetes-native but less user-friendly for end users"
      - "Dual approach (Kustomize + Helm): Maintenance overhead, confusion about which to use"
      - "Single chart: Simpler but couples CRD lifecycle to operator"
    impact: "charts/ structure, deployment process, upgrade workflows, Makefile commands"

  - id: ADR-006
    date: 2025-10-31
    status: accepted
    decision: "Use distroless/static-debian12:nonroot as runtime image"
    reasoning: "Minimal attack surface, no shell, no package manager, non-root by default, industry standard"
    alternatives:
      - "alpine: Has shell and package manager (larger attack surface)"
      - "scratch: Too minimal, missing CA certs"
      - "distroless/base: Includes glibc, we only need static binary"
    impact: "Containerfile, security posture"

  - id: ADR-007
    date: 2025-10-31
    status: accepted
    decision: "Use cockroachdb/errors instead of pkg/errors or stdlib"
    reasoning: "Maintained fork of pkg/errors (which is deprecated), backwards compatible, adds stack traces"
    alternatives:
      - "pkg/errors: Deprecated"
      - "stdlib errors: Too basic, no stack traces"
      - "hashicorp/go-multierror: Different use case"
    impact: "All error handling, pkg/, controllers/"

  - id: ADR-008
    date: 2025-10-31
    status: accepted
    decision: "Namespace-scoped CRDs (not cluster-scoped)"
    reasoning: "Isolation between tenants, follows Kubernetes multi-tenancy best practices, matches PaperMC use case"
    alternatives:
      - "Cluster-scoped: Global visibility, harder multi-tenancy"
      - "Configurable scope: Unnecessary complexity"
    impact: "api/v1alpha1/, RBAC, Helm charts"

  - id: ADR-009
    date: 2025-10-31
    status: accepted
    decision: "Use Kubebuilder v4 scaffolding (not Operator SDK)"
    reasoning: "Lower level, more control, better for learning, Kubebuilder 4.9.0 already installed"
    alternatives:
      - "Operator SDK: Higher level abstraction, less control"
      - "controller-runtime directly: Too low level, missing scaffolding"
    impact: "Project structure, Makefile, main.go bootstrapping"

  - id: ADR-010
    date: 2025-10-31
    status: accepted
    decision: "Simple linear search solver for MVP (not SAT solver)"
    reasoning: "Sufficient for small number of plugins/servers, easier to debug, can optimize later"
    alternatives:
      - "Z3 or gophersat: Overkill for MVP, adds CGO dependency"
      - "No solver: Cannot handle complex constraints"
    impact: "pkg/solver/simple_solver.go, can add z3_solver.go later"
    future: "Add SAT solver in Phase 2 if performance becomes issue"

  - id: ADR-011
    date: 2025-10-31
    status: accepted
    decision: "Use envtest for integration tests (not Kind or real cluster)"
    reasoning: "Fast, built into controller-runtime, no external dependencies, runs in CI"
    alternatives:
      - "Kind: Slower, requires Docker"
      - "Real cluster: Complex setup, not reproducible"
      - "Unit tests only: Insufficient for controllers"
    impact: "Testing setup, CI/CD, coverage targets"

  - id: ADR-012
    date: 2025-10-31
    status: accepted
    decision: "Use github.com/lexfrei/go-hungar for Hangar API client"
    reasoning: "Custom library already built for Hangar, maintained by same author, domain expertise"
    alternatives:
      - "Generic HTTP client: More work, no type safety"
      - "Generated client from OpenAPI: Hangar may not have spec"
    impact: "pkg/plugins/hangar.go, API interactions"

  - id: ADR-013
    date: 2025-10-31
    status: accepted
    decision: "StatefulSet for PaperMC servers (not Deployment)"
    reasoning: "Need stable network identity, persistent storage, ordered deployment/scaling"
    alternatives:
      - "Deployment: No stable identity, PVC issues"
      - "Bare Pods: No automatic recovery"
    impact: "controllers/papermcserver_controller.go, PVC management"

  - id: ADR-014
    date: 2025-10-31
    status: accepted
    decision: "plugins/update/ folder mechanism for plugin hot-swap"
    reasoning: "Native Paper feature, no custom code needed, atomic updates, auto-cleanup"
    alternatives:
      - "Manual JAR replacement: Requires tracking old versions"
      - "Volume mounts: Complex, race conditions"
      - "Custom plugin loader: Reinventing Paper's wheel"
    impact: "Update workflow, JAR file management"

  - id: ADR-015
    date: 2025-10-31
    status: accepted
    decision: "Explicitly NOT a high-availability system"
    reasoning: "Minecraft servers inherently require downtime for updates, 5-10 minutes acceptable, simplifies design"
    alternatives:
      - "HA with load balancing: Minecraft doesn't support this"
      - "Zero-downtime: Impossible with world data persistence"
    impact: "Update strategy, user expectations, documentation"

  - id: ADR-016
    date: 2025-10-31
    status: accepted
    decision: "Two-level caching: in-memory (1h TTL) + persistent (Plugin.status)"
    reasoning: "Fast reconciliation + resilience against API unavailability, orphaned plugin support"
    alternatives:
      - "No cache: Too many API calls"
      - "Only memory: Lost on restart"
      - "Only persistent: Slower reconciliation"
      - "External cache (Redis): Unnecessary complexity"
    impact: "pkg/plugins/cache.go, API client implementations"

  - id: ADR-017
    date: 2025-10-31
    status: accepted
    decision: "Use Ginkgo/Gomega for testing (controller-runtime convention)"
    reasoning: "Standard in Kubebuilder projects, excellent for async testing, BDD style for controllers"
    alternatives:
      - "testify: Good but less suited for async"
      - "stdlib only: Too verbose for complex scenarios"
    impact: "Test suite structure, CI configuration"

  - id: ADR-018
    date: 2025-10-31
    status: accepted
    decision: "updateDelay in both Plugin and PaperMCServer specs"
    reasoning: "Allows community testing period before auto-apply, different policies per resource type"
    alternatives:
      - "No delay: Risky, untested versions"
      - "Global delay only: Not flexible enough"
      - "Manual approval: Too much ops overhead"
    impact: "Constraint solver, update controller logic"

  - id: ADR-019
    date: 2025-10-31
    status: accepted
    decision: "Selector conflict resolution: latest > pinned, highest semver for all-pinned"
    reasoning: "Clear precedence rules, predictable behavior, warning events for visibility"
    alternatives:
      - "Error on conflict: Too strict, breaks GitOps"
      - "First match wins: Non-deterministic"
      - "Explicit priority field: More complex API"
    impact: "pkg/selector/matcher.go, reconciliation logic, status reporting"

  - id: ADR-020
    date: 2025-11-01
    status: accepted
    decision: "Use a-h/templ v0.3.960 for Web UI templates instead of html/template"
    reasoning: "Type-safe templates compiled to Go at build time, prevents runtime errors, better IDE support, automatic XSS protection, aligns with project type-safety philosophy. Note: v0.3.0 in original specification doesn't exist; using latest stable v0.3.960"
    alternatives:
      - "html/template: Runtime template parsing, no type safety, prone to errors"
      - "No templates: Pure Go HTML generation is verbose and error-prone"
    impact: "pkg/webui/templates/, build process (templ generate step), Makefile"

  - id: ADR-021
    date: 2025-11-01
    status: accepted
    decision: "Embed Web UI in operator binary (not separate deployment)"
    reasoning: "Shares K8s client and informer cache, simpler deployment, lower overhead, consistent with single-binary operator philosophy, uses existing RBAC permissions"
    alternatives:
      - "Separate deployment: Duplicates K8s client, additional RBAC, more complex deployment, higher resource usage"
      - "Sidecar container: Still duplicates resources, complex communication"
    impact: "cmd/main.go, pkg/webui/, Helm chart Service definition, single binary deployment"

  - id: ADR-022
    date: 2025-11-01
    status: accepted
    decision: "Web UI on port :8082 with ClusterIP Service and optional Ingress"
    reasoning: "Separates concerns (:8080 metrics, :8081 health, :8082 UI), ClusterIP default for security, Ingress optional via Helm values for production, kubectl port-forward for dev"
    alternatives:
      - "Same port as metrics: Confusing, mixes concerns"
      - "NodePort by default: Less secure, exposes service externally"
      - "LoadBalancer: Expensive, not needed for internal tool"
    impact: "cmd/main.go (port binding), Helm chart Service template, documentation"

  - id: ADR-023
    date: 2025-11-01
    status: accepted
    decision: "No authentication for MVP Web UI (rely on network policies)"
    reasoning: "Simplifies MVP, kubectl port-forward provides secure access for dev, production uses Ingress with external auth (oauth2-proxy), aligns with metrics endpoint pattern"
    alternatives:
      - "K8s RBAC integration: Complex, requires SubjectAccessReview, overkill for MVP"
      - "Basic auth: Weak security, credential management overhead"
      - "OAuth: Too complex for MVP, can add later via Ingress"
    impact: "pkg/webui/server.go (no auth middleware), Helm chart (network policy templates), documentation (port-forward instructions)"
    future: "Add K8s RBAC integration in Phase 2 via SubjectAccessReview for fine-grained permissions"

  - id: ADR-024
    date: 2025-11-01
    status: accepted
    decision: "Use Server-Sent Events (SSE) with K8s watch for live updates instead of polling"
    reasoning: "Real-time updates via K8s watch API, efficient (no polling overhead), native browser support, works with HTMX hx-trigger='sse:update', graceful degradation if SSE fails"
    alternatives:
      - "Polling with hx-trigger='every Xs': Higher latency, unnecessary API load, less responsive"
      - "WebSockets: More complex, bidirectional not needed for read-only UI"
      - "No live updates: Poor UX, requires manual refresh"
    impact: "pkg/webui/sse.go (watch implementation), templates (HTMX SSE directives), browser compatibility (all modern browsers)"

  - id: ADR-025
    date: 2025-11-01
    status: accepted
    decision: "Web UI shares operator's cached K8s client instead of creating separate client"
    reasoning: "Zero additional API load, consistent state with controllers, uses existing informer cache, no additional RBAC needed, efficient memory usage"
    alternatives:
      - "Separate K8s client: Duplicates API calls, cache, and memory, inconsistent state"
      - "Direct API calls: Bypasses cache, high API load, poor performance"
    impact: "cmd/main.go (pass client to webui), pkg/webui/server.go (accepts client), no additional RBAC rules"

  - id: ADR-026
    date: 2025-11-01
    status: accepted
    decision: "Web UI shows single namespace (configurable via flag) for MVP"
    reasoning: "Aligns with operator deployment model (one per namespace), simpler implementation, configurable via --webui-namespace flag, sufficient for most use cases"
    alternatives:
      - "Cluster-wide view: Requires ClusterRole, more complex RBAC, overwhelming for large clusters"
      - "Namespace selector dropdown: More complex UI, needs namespace list endpoint, can add in Phase 2"
    impact: "cmd/main.go (flag), pkg/webui/server.go (namespace filtering), Helm chart (flag value), UI displays single namespace"
    future: "Add namespace selector dropdown in Phase 2 if multi-namespace demand exists"

  - id: ADR-027
    date: 2025-11-02
    status: accepted
    decision: "Paper version management with Docker Hub Registry API, four resolution modes, and critical compatibility constraints"
    reasoning: "PaperMC server images are built to Docker Hub with specific versioning scheme (docker.io/lexfrei/papermc:{version}-{build}). Need to verify image existence before applying updates since images are built once per day. Four resolution modes provide flexibility from fully automated to fully pinned. Status must track both current AND desired state for transparency. Using full docker.io/ path ensures correct registry resolution across different container runtimes. CRITICAL: Plugin compatibility must be checked BEFORE setting desired version, and updates MUST be blocked if any plugin would become incompatible. Never downgrade versions (Paper or plugins) - desired version must always be >= current version."
    alternatives:
      - "Always use latest tag: No version control, risky updates"
      - "Only support pinned versions: No automation, manual maintenance burden"
      - "Build images on-demand: Complex, slow, unnecessary infrastructure"
      - "Use Paper API only without image verification: May reference non-existent images"
      - "Skip compatibility checks: Risk breaking plugins and server functionality"
      - "Allow downgrades: Data corruption risk, unexpected behavior, violates user expectations"
    impact: "api/v1alpha1/papermcserver_types.go (status fields including UpdateBlocked), internal/controller/papermcserver_controller.go (version resolution with compatibility filtering), pkg/registry/ (new package), pkg/paper/client.go (build listing), pkg/solver/ (constraint enforcement)"
    components:
      docker_hub_client:
        package: "pkg/registry/"
        description: "Docker Hub Registry API v2 client using stdlib net/http"
        api_endpoint: "https://hub.docker.com/v2/repositories/lexfrei/papermc/tags"
        authentication: "None (public repository)"
        methods:
          - "ListTags(ctx, repository, pageSize) - List available tags"
          - "ImageExists(ctx, repository, tag) - Verify specific tag exists"
        rationale: "Simple, no external dependencies, sufficient for our needs, avoids heavy Docker SDK"

      image_naming_convention:
        with_build: "docker.io/lexfrei/papermc:{version}-{build} (e.g., docker.io/lexfrei/papermc:1.21.10-91)"
        without_build: "docker.io/lexfrei/papermc:{version} (e.g., docker.io/lexfrei/papermc:1.21.10)"
        latest: "docker.io/lexfrei/papermc:latest"
        verified_examples:
          - "latest"
          - "1.21.9"
          - "1.21.9-59"
          - "1.21.10"
          - "1.21.10-91"
        build_frequency: "Once per day"
        verification_required: true

      status_field_extensions:
        papermcserver_status:
          - field: "desiredPaperVersion"
            type: "string"
            description: "Target Paper version to run (e.g., '1.21.10')"
          - field: "desiredPaperBuild"
            type: "int"
            description: "Target Paper build number (e.g., 91)"
          - field: "currentPaperVersion"
            type: "string"
            description: "Currently running Paper version"
          - field: "currentPaperBuild"
            type: "int"
            description: "Currently running Paper build number"
          - field: "updateBlocked"
            type: "UpdateBlockedStatus"
            description: "Indicates if updates are blocked due to compatibility issues"
            subfields:
              - field: "blocked"
                type: "bool"
                description: "True if update is blocked"
              - field: "reason"
                type: "string"
                description: "Human-readable reason for blocking (e.g., 'Plugin EssentialsX incompatible with Paper 1.21.11')"
              - field: "blockedBy"
                type: "BlockedByInfo"
                description: "Details about which plugin is blocking the update"
                subfields:
                  - field: "plugin"
                    type: "string"
                    description: "Name of the Plugin resource blocking update"
                  - field: "version"
                    type: "string"
                    description: "Current/desired version of the blocking plugin"
                  - field: "supportedPaperVersions"
                    type: "[]string"
                    description: "List of Paper versions this plugin supports (for user visibility)"
        server_plugin_status:
          - field: "currentVersion"
            type: "string"
            description: "Currently installed plugin version"
          - field: "desiredVersion"
            type: "string"
            description: "Target plugin version from solver"
        rationale: "Separate current/desired allows users to see what's running now, what operator wants to install, and when update will happen (maintenance window). UpdateBlocked provides transparency when compatibility constraints prevent updates."

      version_resolution_modes:
        mode_1_latest:
          spec_value: "latest"
          algorithm: |
            1. Collect all matched Plugin resources
            2. Get current Paper version from status.currentPaperVersion
            3. Query Docker Hub for tag named 'latest'
            4. Extract version from 'latest' tag metadata (if available) or query running version
            5. Filter: Remove version if < current (no downgrade)
            6. Filter: Remove version if incompatible with ANY plugin
            7. If filtered out: Set updateBlocked=true with reason and blockedBy, keep current desired
            8. Otherwise: Set desired to 'latest'
          use_case: "Always run newest available Paper version"
          image_verification: "Tag 'latest' always exists by convention"
          compatibility_enforcement: "Yes - checks all matched plugins before setting desired"

        mode_2_auto:
          spec_value: "auto"
          algorithm: |
            1. Collect all matched Plugin resources
            2. Get current Paper version from status.currentPaperVersion
            3. Run constraint solver to find best Paper version for plugin compatibility
            4. Filter: Remove versions < current (no downgrade)
            5. Filter: Remove versions incompatible with ANY plugin
            6. If filtered list is empty: Set updateBlocked=true with reason and blockedBy, keep current desired
            7. Otherwise: Solver selects best version from filtered list
            8. Find latest build for selected version with existing Docker image (see mode 3 algorithm)
            9. Set desired to selected version-build
          use_case: "Automated updates with plugin compatibility guarantee"
          image_verification: "Required after solver picks version"
          compatibility_enforcement: "Yes - constraint solver enforces compatibility with ALL plugins"

        mode_3_version_only:
          spec_value: "{version} (e.g., '1.21.10')"
          algorithm: |
            1. Collect all matched Plugin resources
            2. Get current Paper version from status.currentPaperVersion
            3. Parse specified version
            4. Filter: If specified version < current, set updateBlocked=true (downgrade not allowed), keep current desired
            5. Filter: Check if specified version is compatible with ALL matched plugins
            6. If incompatible with any plugin: Set updateBlocked=true with reason and blockedBy, keep current desired
            7. Otherwise: Query Paper API for all builds of specified version
            8. Sort builds descending (newest first)
            9. For each build, check if docker.io/lexfrei/papermc:{version}-{build} exists in Docker Hub
            10. Return first existing image
            11. Set desired to found version-build
          use_case: "Pin major.minor version, auto-update builds"
          image_verification: "Required for each build until match found"
          compatibility_enforcement: "Yes - checks all matched plugins for specified version"
          error_handling: "If no builds have images, log error and keep existing. If version incompatible, set updateBlocked=true"

        mode_4_pinned:
          spec_value: "{version}-{build} (e.g., '1.21.10-91')"
          algorithm: |
            1. Collect all matched Plugin resources
            2. Get current Paper version from status.currentPaperVersion
            3. Parse specified version-build
            4. Filter: If specified version < current, set updateBlocked=true (downgrade not allowed), keep current desired
            5. Filter: Check if specified version is compatible with ALL matched plugins
            6. If incompatible with any plugin: Set updateBlocked=true with reason and blockedBy, keep current desired
            7. Otherwise: Verify docker.io/lexfrei/papermc:{version}-{build} exists in Docker Hub
            8. If exists: Set desired to specified version-build
            9. If not exists: Set condition ImageNotFound, don't update StatefulSet
          use_case: "Complete version control, manual updates only"
          image_verification: "Required, error if image doesn't exist"
          compatibility_enforcement: "Yes - checks all matched plugins for specified version"
          error_handling: "Set condition to indicate missing image or compatibility issue, don't update StatefulSet"

      caching_strategy:
        decision: "No caching for MVP"
        rationale: "Docker Hub API is fast enough, reconciliation is not frequent, simplifies implementation"
        future: "Could add in-memory cache with 5-minute TTL if needed"

      compatibility_checking:
        description: "CRITICAL - Plugin compatibility MUST be checked before setting desired version"
        algorithm: |
          For each mode (latest, auto, version, pinned):
            1. Collect matched Plugin resources via instanceSelector
            2. Get current Paper version from status.currentPaperVersion (or empty if first reconcile)
            3. For candidate Paper version(s):
               a. Filter out versions < current (no downgrade constraint)
               b. For each remaining candidate version:
                  - Check compatibility with ALL matched plugins
                  - If ANY plugin incompatible: mark candidate as invalid
               c. If all candidates filtered out:
                  - Identify which plugin caused the block
                  - Set updateBlocked.blocked = true
                  - Set updateBlocked.reason = "Plugin '{name}' incompatible with Paper {version}"
                  - Set updateBlocked.blockedBy.plugin = plugin name
                  - Set updateBlocked.blockedBy.version = plugin desired version
                  - Set updateBlocked.blockedBy.supportedPaperVersions = plugin compatibility list
                  - Keep existing desired version (don't change)
                  - DO NOT proceed with update
               d. Otherwise: Select best valid candidate and set as desired version

        no_compatibility_info:
          action: "If plugin has no compatibility metadata (API unavailable, field missing):"
          strategy_fail_safe: "Log warning, assume INCOMPATIBLE, block update (conservative approach)"
          strategy_permissive: "Log warning, assume COMPATIBLE, proceed with update (risky)"
          recommendation: "Use fail-safe for production, permissive only if user explicitly configured compatibilityOverride"

        downgrade_prevention:
          rule: "desired MUST always be >= current (semantic versioning comparison)"
          enforcement: "Check BEFORE compatibility filtering - reject immediately if downgrade detected"
          rationale: "Prevent data corruption, unexpected behavior, and violate user expectations of forward-only updates"
          example: "current=1.21.10, candidate=1.21.9 -> REJECT, set updateBlocked"

      error_handling:
        docker_hub_unavailable:
          action: "Log error, keep existing status.desired* values, don't block reconciliation, retry on next reconciliation"
          status_update: "Do not change updateBlocked (preserve previous state)"

        paper_api_unavailable:
          action: "Same as Docker Hub unavailable, use previous desired version if set"
          status_update: "Do not change updateBlocked (preserve previous state)"

        image_not_found:
          action: "Log warning, set condition to indicate issue, don't update StatefulSet"
          status_update: "Set updateBlocked.blocked=true, reason='Image not found in Docker Hub'"

        plugin_incompatible:
          action: "Set updateBlocked with details, emit Warning event, keep current desired version"
          status_update: "updateBlocked.blocked=true, populate reason and blockedBy"
          user_visibility: "Status visible in kubectl get/describe, event in kubectl get events"

        downgrade_attempt:
          action: "Reject immediately, set updateBlocked, emit Warning event"
          status_update: "updateBlocked.blocked=true, reason='Downgrade not allowed: current={current}, candidate={candidate}'"
          user_visibility: "Clearly indicate downgrade prevention in status and events"

        conditions:
          - type: "ImageAvailable"
            status: "False"
            reason: "ImageNotFound"
            message: "Docker image docker.io/lexfrei/papermc:{version}-{build} does not exist"

          - type: "UpdateBlocked"
            status: "True"
            reason: "PluginIncompatible"
            message: "Plugin '{plugin}' version {version} incompatible with Paper {paper_version}"

          - type: "UpdateBlocked"
            status: "True"
            reason: "DowngradeNotAllowed"
            message: "Cannot downgrade from {current} to {candidate}"

      update_flow:
        step_1: "Reconcile runs"
        step_2: "Collect all matched Plugin resources via instanceSelector"
        step_3: "Get current Paper version from StatefulSet image tag (parse docker.io/lexfrei/papermc:{version}-{build})"
        step_4: "Store in status.currentPaperVersion and status.currentPaperBuild"
        step_5: "Resolve desired version based on spec.paperVersion mode (1-4) WITH compatibility filtering:"
        step_5a: "- Filter candidate versions: remove all < current (downgrade prevention)"
        step_5b: "- Filter candidate versions: remove all incompatible with ANY matched plugin"
        step_5c: "- If all candidates filtered out: set updateBlocked=true with reason/blockedBy, keep current desired, STOP"
        step_6: "If valid candidate found: Store in status.desiredPaperVersion and status.desiredPaperBuild"
        step_7: "Clear updateBlocked (set blocked=false) if previously blocked"
        step_8: "Compare current vs desired"
        step_9: "If different + maintenance window + NOT blocked: update StatefulSet image to docker.io/lexfrei/papermc:{desiredVersion}-{desiredBuild}"
        step_10: "If not in window OR blocked: wait, show difference/block reason in status for user visibility"
        step_11: "Emit appropriate events (Normal UpdateAvailable, Warning UpdateBlocked, etc.)"

phases:
  phase_1_mvp:
    description: "Minimum viable product"
    status: "planned"
    features:
      - "Plugin CRD with instanceSelector"
      - "PaperMCServer CRD with labels"
      - "Basic reconciliation loops"
      - "Hangar API integration only"
      - "Simple linear solver"
      - "RCON graceful shutdown"
      - "Cron-based maintenance windows"
      - "Persistent cache in status"
      - "Separate CRD Helm chart"

  phase_2_enhanced:
    description: "Additional plugin sources and optimizations"
    status: "future"
    features:
      - "Modrinth API support"
      - "SpigotMC API support"
      - "URL-based plugin source"
      - "SAT solver for complex constraints"
      - "Admission webhooks for validation"
      - "Web UI namespace selector (multi-namespace view)"
      - "Web UI authentication via K8s RBAC (SubjectAccessReview)"
      - "Web UI filtering and search capabilities"

  phase_3_advanced:
    description: "Advanced features"
    status: "future"
    features:
      - "Plugin dependency support"
      - "Canary deployments"
      - "Automatic compatibility testing"
      - "E2E test suite with real servers"
      - "Grafana dashboards"

  phase_4_enterprise:
    description: "Enterprise capabilities"
    status: "future"
    features:
      - "Multi-cluster federation"
      - "GitOps integration (Flux/ArgoCD)"
      - "Backup/restore integration"
      - "Advanced scheduling (blue-green)"
      - "Plugin dependency graph visualization"

observability:
  metrics:
    exporter: "Prometheus"
    endpoint: "/metrics"
    port: 8080
    key_metrics:
      - "minecraft_operator_plugin_reconcile_duration_seconds"
      - "minecraft_operator_plugin_matched_servers_total"
      - "minecraft_operator_server_reconcile_duration_seconds"
      - "minecraft_operator_server_update_success_total"
      - "minecraft_operator_server_update_failure_total"
      - "minecraft_operator_webui_requests_total"
      - "minecraft_operator_webui_sse_connections_total"

  logging:
    format: "structured (logr)"
    levels:
      - "info - Normal operations"
      - "error - Reconciliation failures"
      - "debug - Detailed solver output"

  events:
    provider: "Kubernetes Events"
    key_events:
      - "Normal Resolved - Plugin version resolved"
      - "Normal UpdateAvailable - New version available"
      - "Normal UpdateCompleted - Update successful"
      - "Warning IncompatibleVersion - No compatible version"
      - "Warning RepositoryUnavailable - API unavailable"
      - "Warning UpdateFailed - Update failed"

  webui:
    endpoint: "/ui"
    port: 8082
    features:
      - "Dashboard view of all PaperMCServer instances"
      - "Real-time updates via SSE"
      - "Server details with current/desired state"
      - "Plugin list with resolved versions"
      - "Maintenance window schedule display"
      - "Update status and history"

  tracing:
    status: "future"
    consideration: "OpenTelemetry integration in Phase 3"

documentation:
  api_docs: "Generated from Go code comments"
  user_guide: "README.md with quick start"
  architecture: "DESIGN.md (comprehensive design document)"
  adr: ".architecture.yaml (this file, single source of truth)"
  examples: "examples/ directory with sample CRDs"
  helm_readme: "charts/*/README.md for each chart"

development:
  ide: "Any with Go support"
  required_tools:
    - tool: "go"
      version: "1.25+"

    - tool: "kubebuilder"
      version: "4.9.0"

    - tool: "controller-gen"
      version: "v0.22.3"
      source: "Installed with kubebuilder"

    - tool: "kustomize"
      version: "v5.0+"

    - tool: "podman"
      version: "latest"

    - tool: "helm"
      version: "3.14+"

    - tool: "golangci-lint"
      version: "v1.62+"

    - tool: "kind"
      version: "v0.20+"
      optional: true
      purpose: "Local testing cluster"

  local_development:
    - "Use 'make manifests' to generate CRDs from Go types"
    - "Use 'make generate' to generate deepcopy methods"
    - "Use 'make templ' to generate Go code from templ templates"
    - "Use 'make test' to run unit tests"
    - "Use 'make run' to run operator locally (connects to kubeconfig cluster)"
    - "Use 'make docker-build' to build container image"
    - "Use 'make install' to install CRDs into cluster"
    - "Use 'make deploy' to deploy operator to cluster"
    - "Access Web UI locally: kubectl port-forward -n minecraft-operator-system svc/minecraft-operator 8082:8082"

  debugging:
    - "Delve for Go debugging"
    - "kubectl logs for operator logs"
    - "kubectl describe for resource status"
    - "kubectl get events for events"

makefile_targets:
  core:
    - target: "manifests"
      command: "controller-gen crd paths=./api/... output:crd:dir=charts/minecraft-operator-crds/crds output:rbac:dir=charts/minecraft-operator/templates/rbac"
      description: "Generate CRD and RBAC YAML from Go types"

    - target: "generate"
      command: "controller-gen object paths=./api/..."
      description: "Generate deepcopy methods"

    - target: "templ"
      command: "templ generate -path pkg/webui/templates"
      description: "Generate Go code from templ templates"

    - target: "test"
      command: "go test ./... -coverprofile cover.out"
      description: "Run unit tests with coverage"

    - target: "test-e2e"
      command: "KIND=kind KIND_CLUSTER=minecraft-operator-test-e2e go test -tags=e2e ./test/e2e/"
      description: "Run e2e tests with Kind cluster"

    - target: "lint"
      command: "golangci-lint run"
      description: "Run Go linters"

    - target: "lint-fix"
      command: "golangci-lint run --fix"
      description: "Auto-fix linting issues"

    - target: "build"
      command: "go build -o bin/manager cmd/main.go"
      description: "Build operator binary"

    - target: "run"
      command: "go run ./cmd/main.go"
      description: "Run operator locally against kubeconfig cluster"

    - target: "container-build"
      command: "podman build --tag ghcr.io/lexfrei/minecraft-operator:latest --file build/Containerfile ."
      description: "Build container image"

    - target: "container-push"
      command: "podman push ghcr.io/lexfrei/minecraft-operator:latest"
      description: "Push container image to registry"

    - target: "helm-lint"
      command: "helm lint charts/minecraft-operator-crds && helm lint charts/minecraft-operator"
      description: "Lint Helm charts"

    - target: "helm-install-crds"
      command: "helm install minecraft-operator-crds charts/minecraft-operator-crds --create-namespace --namespace minecraft-operator-system"
      description: "Install CRD chart into cluster"

    - target: "helm-install"
      command: "helm install minecraft-operator charts/minecraft-operator --namespace minecraft-operator-system"
      description: "Install operator chart into cluster (auto-installs CRDs)"

    - target: "helm-upgrade"
      command: "helm upgrade minecraft-operator charts/minecraft-operator --namespace minecraft-operator-system"
      description: "Upgrade operator in cluster"

    - target: "helm-uninstall"
      command: "helm uninstall minecraft-operator && helm uninstall minecraft-operator-crds --namespace minecraft-operator-system"
      description: "Remove operator and CRDs from cluster"

quick_reference:
  scaffold_project: |
    # Initialize project (if starting from scratch)
    kubebuilder init --domain mc.k8s.lex.la --repo github.com/lexfrei/minecraft-operator

    # Create APIs
    kubebuilder create api --group mc.k8s.lex.la --version v1alpha1 --kind Plugin --resource --controller
    kubebuilder create api --group mc.k8s.lex.la --version v1alpha1 --kind PaperMCServer --resource --controller

    # Configure controller-gen for CRD chart output
    # Edit Makefile to set: output:crd:dir=./charts/minecraft-operator-crds/crds

  development_workflow: |
    1. Make changes to api/v1alpha1/*.go or pkg/webui/templates/*.templ
    2. Run 'make manifests generate templ' to update CRDs, generated code, and templates
    3. Run 'make test' to verify tests pass
    4. Run 'make lint' to check code quality (ALL errors must be fixed)
    5. Run 'make run' to test locally (Web UI available at http://localhost:8082)
    6. Commit changes with semantic commit message and GPG signing
    7. Push to feature branch
    8. Create PR (NEVER push to main/master)

  deployment_workflow: |
    1. Build image: make container-build IMG=ghcr.io/lexfrei/minecraft-operator:v1.0.0
    2. Push image: make container-push IMG=ghcr.io/lexfrei/minecraft-operator:v1.0.0
    3. Update chart versions in Chart.yaml files
    4. Lint charts: make helm-lint
    5. Install CRDs: make helm-install-crds
    6. Deploy operator: make helm-install
    7. Verify: kubectl get pods -n minecraft-operator-system

  helm_workflow: |
    # Development
    make helm-install-crds  # Install CRDs
    make helm-install       # Install operator

    # Updates
    make manifests          # Regenerate CRDs after API changes
    make helm-upgrade       # Upgrade operator deployment
    kubectl apply -f charts/minecraft-operator-crds/crds/  # Manually upgrade CRDs

    # Cleanup
    make helm-uninstall     # Remove everything

important_notes:
  - "This is NOT a high-availability system - 5-10 min downtime during updates is acceptable"
  - "Helm-only deployment (NO Kustomize) - CRDs in separate chart with independent lifecycle"
  - "CRDs generated to charts/minecraft-operator-crds/crds/ via make manifests"
  - "RBAC generated to charts/minecraft-operator/templates/rbac/ via make manifests"
  - "Templ templates generated to .go files via make templ (run before build)"
  - "Main entrypoint is cmd/main.go (NOT root main.go)"
  - "terminationGracePeriodSeconds CRITICAL - never set too low (world corruption risk)"
  - "plugins/update/ is standard Paper mechanism - don't reinvent"
  - "Always use feature branches - NEVER commit to main/master"
  - "GPG signing required for all commits"
  - "ALL linting errors must be fixed before push - no exceptions"
  - "API domain is mc.k8s.lex.la (NOT paperstack.io)"
  - "Use podman not docker per global CLAUDE.md"
  - "updateDelay allows community testing before auto-apply"
  - "Constraint solver ensures ALL matched servers are compatible"
  - "Cache has two levels: memory (1h) + persistent (status)"
  - "Selector conflicts: latest policy wins, or highest semver"
  - "Web UI embedded in operator binary - shares K8s client and cache"
  - "Web UI on port :8082 - use kubectl port-forward for local access"
  - "Web UI has NO authentication by default - rely on network policies"
  - "Web UI uses SSE for real-time updates via K8s watch API"

references:
  design_doc: "DESIGN.md"
  project_readme: "README.md (to be created)"
  kubebuilder_book: "https://book.kubebuilder.io"
  controller_runtime_docs: "https://pkg.go.dev/sigs.k8s.io/controller-runtime"
  papermc_docker: "https://github.com/lexfrei/papermc-docker"
  hangar_api_client: "https://github.com/lexfrei/go-hungar"
  paper_api: "https://papermc.io/api/docs"
  rcon_protocol: "https://developer.valvesoftware.com/wiki/Source_RCON_Protocol"
